%----------------------------------------------------------------------------------------
%	OPACITY METHODS
%----------------------------------------------------------------------------------------
%\section{Opacity derivation}
%\label{se:opacities}
%\input{Opacities}
%\input{Opacity_checks}


Only a fraction of the signal is transmitted by the atmosphere and
reaches NIKA2 detectors. 
The relation between uncorrected observed flux densities
$\tilde{S}_{\nu}$ and top-of-the-atmosphere flux densities $S_{\nu}$
is parametrized from the zenith opacity $\tau_{\nu}$
and the line-of-sight air mass $x$, such as
\begin{equation}
\tilde{S}_{\nu} = S_{\nu} \, e^{-\tau_{\nu} \cdot x}.
\label{eq:uncorr_flux}
\end{equation}

An accurate derivation of the opacity condition for each scan is
required in order to retrieve the source signal at the top of the
atmosphere. Opacity correction uncertainties even prevail in the
final calibration error budget (see Chapter~\ref{se:error}).

We developped three opacity derivation methods, which are discussed
in the sections below, and extensively tested their robustness against
observing condition. The 'taumeter' method discussed in
Sect~\ref{se:taumeter-method} relies on measurements provided by the
resident IRAM tau-meter operated at $225~\rm{GHz}$ and a fit of the
opacity estimates in NIKA2 frequency bands by imposing the flux
density stability against atmospheric condition. The 'skydip' method
described in Sect~\ref{se:skydip-method} consists in using NIKA2 as a
taumeter by resorting to a series of skydip scans, the selection of
which is addressed in Sect.~\ref{se:skydip-selection}. Finally, the
'corrected skydip' method presented in Sect.~\ref{se:corrected-skydip}
is a modifed version of the 'skydip' method that minimizes the
dependence of the measured flux density on the opacity.\\


Consistency check between two independent methods, the \emph{taumeter}-
and \emph{skydip}-based methods, constitutes a first
robustness test, which is addressed in this chapter.
Then, the opacity estimates in NIKA2 bands are
ultimately tested by assessing the stability of the
top-of-the-atmosphere flux densities for a large range of
atmsopheric conditions, as discussed in Chapter~\ref{se:photometry}.



%----------------------------------------------------------------------------------------
%	taumeter Method
%----------------------------------------------------------------------------------------
\section{Taumeter-based method {\color{blue} Laurence}}
\label{se:taumeter-method}

We use a series of 64 scans of MWC349
acquired during N2R9 campaign to fit the relations between the IRAM
$225$GHz taumeter opacities and NIKA2 band pass opacities. This data
set consists of the baseline selected sub-set of scans from the 68
available scans for this source during N2R9. It constitutes an
homogeneous data set in flux density but heterogeneous in atmospheric
conditions: zenith opacities at $225$GHz range from
0.08 to 0.32 and elevations from $23$ to $73$ degrees. NIKA2 opacities
$\tau_\nu$, for $\nu$ corresponding
to Array 1, 2, 3 and the combination of Arrays 1 and 3, are estimated
from the $225$GHz taumeter opacity measurements $\tau_{225}$ as
\begin{equation}  
  \tau_\nu =  a_\nu^{225}\tau_{225} + b_\nu^{225},          
\end{equation}
where the parameters $a_\nu^{225}$ and $b_\nu^{225}$ are fitted to ensure
that the non-corrected flux densities $\tilde{S}_\nu$ are stable againts
$\tau_{225}$ after correction of the atmospheric attenuation by
inversion of Eq.~\ref{eq:uncorr_flux} using 
\begin{equation}  
  S_\nu = \tilde{S}_\nu e^{(a_\nu^{225}\tau_{225} + b_\nu^{225}) \cdot x}.
  \label{eq:opacorr_taumeter}
\end{equation}

We tested two estimators of the flux stability. The first one relies
on minimising the
standard deviation of the measured-to-median flux densities ratio
after correction of the opacity using Eq.~\ref{eq:opacorr_taumeter}. The second
one consists in rewriting the rms minimisation as an unweighted
$\chi^2$ minimisation using:
\begin{equation}
\chi^2 = \sum_{i=1}^{N} \frac{1}{\sigma^2} \, \left( \frac{S_\nu}{Med(S_\nu)} -1 \right)^2,  
\end{equation}
where $\sigma$ is the rms error of the flux density estimates. Note
that these estimators are not independent and they do not depends on
the flux density of the source.  


% bf_a     = 1.9401878      0.94233333       1.8952941       1.9342579
% err_bf_a = 0.16605729     0.097230351     0.084799830      0.12000000
% bf_b     =  -0.045000000       0.0000000    -0.058426966    -0.055000000
% err_bf_b = 0.049497475     0.026340184     0.021199958     0.038890873

% -0.043488288  -0.00057861635    -0.060658083    -0.053333333
% 0.050634888     0.027028985     0.022710888     0.040069384

$a = [1.94,  0.94,  1.86,  1.92]$

$b = [-0.04, 0.00, -0.07, -0.06]$


\begin{figure}[ht!]
  \begin{center}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_taumeter_mwc349_a1.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_taumeter_mwc349_a3.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_taumeter_mwc349_1mm.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_taumeter_mwc349_a2.pdf}
    \caption[IRAM taumeter to NIKA2 opacity model]{IRAM $225$GHz taumeter to
    NIKA2 opacity relation fit.
    The $a_{\nu}^{225}$ and
    $b_{\nu}^{225}$ parameter space is explored for Array 1 (upper left),
    Array 3 (upper right), the combination of 1mm arrays (lower left)
    and Array 2 (lower right).
    The red contours correspond to rms
    errors of the measured-to-median flux density ratio of $9\%$, $10\%$
    and $12\%$ at 1mm and $4.5\%$, $5\%$ and $6\%$ at 2mm. The blue
    contours are the $68$, $95$ and $99\%$ confidence
    level contours of the parameters estimated using the $\chi^2$
    minimization.
    The best fit values are shows as green stars} 
\label{fig:taumeter_fit}
\end{center}
\end{figure}






%----------------------------------------------------------------------------------------
%	skydip-based Method
%----------------------------------------------------------------------------------------
\section{Skydip-based method {\color{blue} Xavier $\&$ Laurence}}
\label{se:skydip-method}

% LP: copie de l'intro de Xavier
In NIKA2, the opacity is measured via a total-power technique, which was
successfully tested with NIKA. The details of this technique and its agreement
with the Atmospheric Transmission at Microwaves (ATM) model
(\cite{2001IEEE....49.1683C}) are described in \cite{Catalano:2014nml}. The
underlying idea is to replace the opacity, usually delivered by the resident
IRAM tau-meter that performs elevation scans at a fixed azimuth and is
operating at 225\,GHz, by a measurement that uses the NIKA2 instrument itself
as a tau-meter. Using this procedure we can directly derive an opacity
integrated in the NIKA2 very bandpasses and in the same line-of-sight of the
source in the considered map. For that purpose, we assume that the resonance
frequency of each KID varies linearly with the total power. First, we have to
calibrate the relationship between total power and opacity. Then we can use
that calibration to measure the opacity during a given scan.
% fin copie

For each KID $k$, the absolute value of the resonance frequency
$f_{tone}^k$ moves with the atmospheric load according to

\begin{equation}
\ftone^k  = C_0^k - C_1^k T_{atm}[1-e^{-\tau/\sin\delta}]
\label{eq:skydip}
\end{equation}

%FXD corrected 
%{\bf LP: pourquoi signe plus alors qu'on utilise un signe moins dans
%  Eq. 2 du papier instru ?}

where $C_0^k$ is a constant equal to the resonance
frequency at zero opacity, $C_1^k$ is the calibration conversion
factor in kHz$/$K, $T_{atm}$ is the equivalent temperature
of the atmosphere (taken as a constant at 270~K), $\tau$ the zenith
opacity and $\delta$ the average elevation of the telescope.
By assuming a homogeneous plane-parallel atmosphere, the airmass $x$ is defined from the
elevation as $x = \left(\sin\delta\right)^{-1}$. 

The coefficients $C_0^k$ and $C_1^k$ are expected to be constant in
time within at least a cooldown cycle, and are determined using a {\tt
skydip} procedure. This consists in moving the telescope in elevation
step by step and monitoring, for each kid, the evolution of $\ftone^k$
versus the air mass and to fit the zenith opacity $\tau$ and $C_0^k$
and $C_1^k$. This process is realised by performing a skydip scan, as
defined in~Sect.~\ref{se:skydip}. The acquisition time spend on each
elevation step, wich is of about twenty seconds, is chosen to reduce
the error in the determination of $\ftone^k$.

All skydips, obtained under various opacity
conditions, are analysed together to break the degeneracies between
the opacity and the responsivity ($C_1^k$). The procedure has two steps.
First, all the skydips are analysed individually to simply extract
$\ftone^k$ for each stable elevation. Secondly, a simultaneous fit is done
for all 
parameters ($\tau$, $C_0^k$ and $C_1^k$.)
Error bars on $\tau$ are estimated by doing
this procedure on blocks of 40 kids only and getting a dispersion on the
resulting $\tau$ from the different blocks. Usually the dispersion comes out as
$4\times 10^{-3}$ at 1 mm and $1\times 10^{-3}$ at 2 mm. Once the $\tau$ values
are estimated for each skydip (as the average over the blocks), we compute
(while fixing $\tau$) the $C_0$ and $C_1$ final values for each KID. We thus
retrieve the coefficients of all the KIDs even though some of them could not
contribute to the $\tau$ determination.

This procedure consists thus in fitting a couple of paramaters ($C_0$,
$C_1$) for each of the several thousand valid KIDs. This requires to
have on hands a sizable amount of skydip scans -- typically ten to
twenty -- that i) span the whole opacity range and ii) avoid hightly
perturbated atmosphere to met the plane-parallel atmosphere
assumption. To that aim, we recommand to perform a skydip scan twice a
day during a scientific campagn. Then during the ($C_0$, $C_1$)
determination process, the skydip scan are thoroughtly selected.

   
%----------------------------------------------------------------------------------------
%	skydip selection
%----------------------------------------------------------------------------------------
\section{Skydip selection {\color{blue} Laurence}}
\label{se:skydip-selection}

\begin{figure}[p]
\begin{center}
\includegraphics[clip=true,width=0.9\linewidth]{Figures/Opacity/plot_skydip_selection_two_crit.pdf}
\caption[N2R9 skydip scan selection.]{ Median dT quality-fit criterion is plotted in fonction of Median rms criterion for each skydip scans of the N2R9 campaign and for the three arrays. Both criteria are nicely correlated. Empty diamonds show the results of the first iteration of the skydip coefficient estimation, whereas filled circled show the second iteration, for which only the skydips that met both fit-quality criteria are included. After the second iteration, all the remaining skydips met the criteria.}
\label{fig:skydipselection}
\end{center}
\end{figure}

For each skydip scan and for each bunch of 40 KIDs, we compute the
difference between the measured KID resonance frequency and the model
given in Eq.~\ref{eq:skydip} taken at the best-fit values of the
($C_0$, $C_1$) parameters. Then we determine two indicators
of the fit quality per skydip. First, the standard deviation of the
measure-to-model difference is calculated over all the KIDs in a
bunch. For each skydip, we evaluate the median rms, which is the
median over the KID bunches of the standard deviation per bunch, given
in Hz. Secondly, for each scan, we compute the average
measure-to-model difference of each KID $k$, labelled $dT_k$, which is
then converted from Hertz to Kelvin using the $C_1$ parameter of the
KID $k$. Median $dT$ is the median of $dT_k$ over all the KID of an
array. With these two indicators in hands, we discard the skydip scans
that are noisy or that yield a poor fit by applying the selection
criteria

\begin{itemize}
\item Median $\rm{rms} < 1.5 \times 10^{4}~\rm{Hz}$
\item Median $dT < 1.6~\rm{K}$
\end{itemize}

The threshold values have been determined using the set of 44 skydip
scans of N2R9. The Median rms cut corresponds to twice the median of
this quantity per skydip scan, whereas the Median $dT$ cut is twice
the standard deviation of Median $dT$ over the skydips. N2R9 skydip
scan selection is illustrated in Fig.~\ref{fig:skydipselection}, in
which the agreement between the two fit-quality criteria is clearly
seen. The ($C_0$, $C_1$) estimation proceeds in two steps: first the
parameters are estimated using all the available skydip scan for a
given campaign, then the estimation is re-iterated using the only
skydip scans that met the fit-quality criteria. After the second
iteration, we check that no extra skydip outlier are left, as shown by
the 'v2' label data points in Fig.~\ref{fig:skydipselection}.


\addparag{stability against the skydip scan selection + FIG}
We test the stability of the ($C_0$, $C_1$) parameters against the exact choice of the selection criteria.  
At 1mm, we find about {\color{red} $[$TBC$]$  $10\%$} opacity variation from very inclusive to very aggressive selections. However, at 2mm, this scatter reachs about {\color{red} $[$TBC$]$  $30\%$} relative uncertainties.


We conclude that opacities at 1mm can be reliably estimated from a series of skydip scans using the (C0, C1) model. By contrast, for the 2mm opacities, a skydip-based method is not stable enough against the skydip selection. Thus, we adopt an hybrid approach. 

%\section{The hybrid method}

%The hybrid method comprizes two-steps: i) first the 1mm opacities,
%that are $\tau_{A1}$ and $\tau_{A3}$, are determined using the skydip
%method described in Sect.~\ref{se:skydip-method}, ii) then the 2mm
%opacity $\tau_{A2}$ is extrapolated from the 1mm ones using a modified
%ATM model. Namely, for the second step, we perform:

%\begin{equation}
%\tau_{A2} = \left( \left.\frac{\tau_{A2}^{\rm{ATM}}}{\tau_{A3}^{\rm{ATM}}}\right\vert_{\tau_{A3}} + \alpha \right) \tau_{A3},
%\end{equation}

% where $\alpha$ is an offset, which are estimated from the observations themselves, and the ratio is the predicted zenith opacity ratio for A2 and A3 frequency bands using the ATM model described in \ref{Pardo2002} and taken at the measured A3 zenith opacity. The zenith opacity expectations for the array $A_i$ is
%\begin{equation}
%  \tau^{\rm{ATM}}_{A_i} = - \ln{\frac{\int e^{-\tau^{ATM}(\nu)} T_{A_i}(\nu) d\nu}{ \int T_{A_i}(\nu) d\nu}},
%\end{equation}
%where the bandpasses $T_{A_i}$ for arrays $A_i$, $i=1, 2, 3$, are the Martin-Pupplet reference transmissions
%corrected by a Rayleigh-Jeans term  $T'_{A_i}(\nu) / \left( \frac{\nu}{\nu_0}\right)^2$. 

%We observe that the measured \emph{shape} of the measured opacity ratio is well described by the ATM expectations whereas its \emph{amplitude} is too low by an offset $\alpha$, which we dertermine using a data-driven approach. We estimate $\alpha$ as the offset that ensures a stability of the A2 flux over the whole opacity span.  

%\addparag{$\alpha$ fit + FIG}




%----------------------------------------------------------------------------------------
%	Corrected skydip method
%----------------------------------------------------------------------------------------
\section{Corrected skydip method {\color{blue} Laurence}}
\label{se:corrected-skydip}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 1-params correction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
We use the flux stability estimators described in
Sect.~\ref{se:taumeter-method} to fit a correction to the 'skydip'
opacities $\tau_{\rm{skydip}}$ as
\begin{equation}  
  \tau_\nu =  a_\nu^{\rm{skydip}}\tau_{\rm{skydip}}.        
\end{equation}

We find $a_\nu^{\rm{skydip}}$ of
$1.36 \pm 0.04$,
$1.23 \pm 0.02$,
$1.27 \pm 0.03$ and
$1.03 \pm 0.03$ for A1, A3, A1$\&$A3 and A2 respectively.
% a   = 1.3600000       1.0318470       1.2326556       1.2660000
% s_a = 0.038587182     0.028553570     0.019324699     0.026832816


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 2-params correction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[ht!]
  \begin{center}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_skydip_mwc349_a1.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_skydip_mwc349_a3.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_skydip_mwc349_1mm.pdf}
    \includegraphics[clip=true, trim={0, -0.3cm, -0.3cm, 0}, width=0.42\textwidth]{Figures/Opacity/fit_nika2_tau_from_skydip_mwc349_a2.pdf}
    \caption[NIKA2 skydip-based opacity correcting
    relation]{Fit of the skydip-based opacity correcting relation
    parameters.
    The flux-stability estimator contours are shown in the plan
    $a_{\rm{skydip}} \equiv a_\nu^{\rm{skydip}'}$ and
    $b_{\rm{skydip}} \equiv b_\nu^{\rm{skydip}'}$
    for A1, A3, A1$\&$A3 and A2.
    The red contours enclose rms
    errors of the measured-to-median flux density ratio of $5.5$, $7$
    and $10\%$ at 1mm and $2.7$, $3.5$ and $5\%$ at 2mm. The blue
    contours correspond roughthly to the $68\%$, $95\%$ and $99\%$
    confidence levels drawn from the $\chi^2$ estimates.
    The best fit values are shows as green stars. Offset
    $b_\nu^{\rm{skydip}'}$ are compatible with zero within the $68\%$
    CL contours.} 
\label{fig:skydip_fit}
\end{center}
\end{figure}

Moreover, we test for an offset $b_\nu^{\rm{skydip}'}$ in the
correcting relation of the 'skydip' opacities as 
\begin{equation}  
  \tau_\nu =  a_\nu^{\rm{skydip}'}\tau_{\rm{skydip}} + b_\nu^{\rm{skydip}'}.      
\end{equation}
We repeat estimating the parameters of the correcting
relation. Confidence level contours in the parameter plan using the
two stability estimators are skown in Fig.~\ref{fig:skydip_fit}, as
well as the
best-fitting parameter values.
We find the best-fit $a_\nu^{\rm{skydip}'}$ estimates of
$1.36 \pm 0.04$,
$1.25 \pm 0.07$,
$1.28 \pm 0.04$ and
$1.05 \pm 0.05$ for A1, A3, A1$\&$A3 and A2 respectively, which are in
agreement with the best-fit values estimated using the single-parameter
correcting relation, whereas the best-fit values of the offsets
$b_\nu^{\rm{skydip}'}$ are compatible with zero at both wavelengths.
% a   = 1.3600000       1.0467126       1.2476650       1.2792013
% s_a = 0.037853031     0.050552977     0.068354972     0.044088207
% b   = -0.0053333333    -0.014432990    -0.040000000    -0.030731707
% s_b = 0.011925696     0.012184154     0.030641294     0.020823168


