
\section{Kinetic Inductance Detectors}
\label{se:kids}


%\subsection{Presentation rapide des detecteurs}
%\subsection{Photometrie}
%\subsubsection{Rf}
%\subsubsection{Cf}
%
%\subsection{Non linearite par l'observation d'une source ponctuelle}

%%%%

\subsection{Description}

The theory of superconductivity described by \citep{PhysRev.108.1175} show that at low temperature, there is an attraction between electrons due to electron-phonon interactions that bind electrons together to form call Cooper pairs \citep{PhysRev.104.1189}. In superconductors this state is primarily responsible for superconductivity. When incident photons with sufficient energy are absorbed by the detector's superconducting film, they break Cooper pairs which increases the quasi-particles density and causes a change in the kinetic inductance $L_{K}$. The shift in the kinetic inductance $\delta L_{K}$ is proportional to the density of quasi-particles $\delta L_{K} \propto \delta n_{qp}$, which is directly proportional to the absorbed incident power : $\delta n_{qp} \propto \delta P_{opt}$.
Kinetic Inductance Detectors (KIDs) are RLC superconducting resonator introduced by \citep{2003Natur.425..817D} and that use this principle. Their resonant frequency is given by : 

\begin{equation}
f_{0} = \frac{1}{2\pi \sqrt{(L_{k}+L_{G})C(\varepsilon)}}, 
\end{equation}
 
where $L_{K}, L_{G}$ and $C$ are the resonator's kinetic inductance, geometric inductance and capacity. $\varepsilon$ is the material permittivity.
When a KID absorbs photons, its resonant frequency varies like :

\begin{equation}
\delta f_{0} = -\frac{1}{2}C(\varepsilon)f_{0}^{3} \delta L_{K}.
\end{equation}

A small change in the kinetic inductance results in a proportional shift of the resonant frequency. As a result, there is a linear relation between the absorbed optical power by the detector and the shift of the resonant frequency :

\begin{equation}
\delta f_{0} \propto -\delta P_{opt}.
\end{equation}

This is represented in Fig.~\ref{fig:resonance}. It is then possible to measure a variation of flux on the sky by measuring the shift of resonant frequency of a detector. Two methods that are use to follow this shift are described further.

\begin{figure}
  \includegraphics[clip, angle=0, width=\columnwidth]{Figures/resonance.png}
  %	\includegraphics[clip, angle=0, width=\columnwidth]{Figures/resonance.pdf}
  \caption{Schematic representation of a KID resonance in amplitude (left) and phase (right), as a function of the excited tone injected in the feedline. The optical power absorbed by the detector is weak for black curves and increases for red curves. The absorption of a photon shifts the resonance frequency and this is directly proportional to the received power.}
  \label{fig:resonance}
\end{figure}


\begin{figure}
\center
\includegraphics[clip, angle=0, width=\columnwidth]{Figures/KID-linearity-Monfardini2014.png}
\caption{KID linearity demonstrated in laboratory under realistic
  conditions. The plot shows the frequency shift of the resonance as a function
  of the optical background temperature (K). Solid line : linear fit of the
  experimental points. Credits : \citet{2014JLTP..176..787M}.}
\label{fig:KID-lin}
\end{figure}

Laboratory measurements with \todo{XXXX describe set up XXX} have shown that
KIDs are linear over a wide range of backgrounds (Fig.~\ref{fig:KID-lin}). Like all detectors, measures done by KIDs can become non-linear at a certain point. Physically, non-linearity in a KID could appear as a consequence of too strong currents inside the resonator or to too strong induced magnetic fields. This leads to an increase in the quasi-particles density and the kinetic inductance, which could cause a loss of superconductivity \citep{Calvo2008} \todo{(articles Pippard, Parmenter ?)}. In this paper, we will study KID non-linearity in different conditions. 

%Kinetic Inductance Detectors (KIDs) are RLC superconducting resonator, made from a thin metal film and introduced by \citep{2003Natur.425..817D}. They are based on a novel superconducting detector technology that provides high sensitivity and ease of multiplexing. 
%
%\citep{2016A&A...592A..26C} show that KID arrays behave appropriately in a space-like environment, they present short time constants making them less sensitive to cosmic rays compared to bolometers. This features make KIDs competitive with other technologies to be implemented in futur ground base or space CMB mission.
%In this section we give a brief summary of their main features and how photometry can be derived from their measurements, then we study the KID non-linearity, a systematic effect that must be taken into account in the design of futur experiments.
%
%This relation is linear for small variations in $P_{opt}$
%\citep{2010ApPhL..96z3511S}. 

\subsection{Transfer function}

A KID circuit is coupled to a transmission feedline that is expressed by the $S_{21}$ parameter. The KID transfer function reads : 

\begin{equation}
S_{21}(f) = \mathcal{I} +j\mathcal{Q} .
\end{equation}

\noindent where $\mathcal{I}$ and $\mathcal{Q}$ give respectively the real (in phase) and imaginary
(quadrature) of $S_{21}$. A model of a KID transfer function has been proposed
by \citet{2008ApPhL..93m4102G} :

\begin{equation}
S_{21} = \frac{2Z_{res}Z_{0}}{Z_{res}[2Z_{0} + j(X_{1}+X_{2})] + (Z_{0} +jX_{1})(Z_{0} +jX_{2})},
\end{equation}

with:

\begin{equation}
Z_{res} = \frac{Z_{0}Q_{e}}{2Q_{i}}[1 + 2jQ_{i}\frac{(f-f_{0})}{f_{0}}],
\end{equation}

\noindent where $X_{1}$, $X_{2}$, $Z_{0}$ are impedances, $Q_{i}$ is the
intrinsic quality factor of the resonator and $Q_{e}$ is the external quality
factor due to coupling with the measurement electronics. $f$ is the frequency of
excitation of the detector, and $f_{0}$ is the resonant frequency. Throughout
this paper, we shall assume typical values of KIDs $X_{1} = X_{2} =
0.5\,\Omega$, $Z_{0} = 50\,\Omega$, $Q_i=2\times 10^4$, $Q_e=10^4$ and $f_{0} =
1.8\times 10^9$\,Hz as measured on \nika\ and \nikad. The following section
addresses how the resonance of a KID is monitored and related to the incident
optical power.

% \section{Methods of signal reconstruction}
\subsection{Photometry}
\label{sec:signal}

A dedicated KID readout system has been developed by \citet{2013A&A...551L..12C}
and successfully used for \nika\ and \nika2\ \citep{2010A&A...521A..29M,2016JLTP..184..816C}. We here summarize its main charcteristics and the observables
that are relevant for our simulation work. We then present two ways to use them
to derive the photometry.

%% To convert the $\I(t)$ and $\Q(t)$ that
%% describe the resonance frequency shift $\delta f_0$ to the absorbed optical
%% power $\delta P_{opt}$. We have devised two ways to relate these
%% quantities. Both rely on a specific electronic modulation readout devised by
%% \citet{2013A&A...551L..12C} that we summarize first.

\subsubsection{Modulated readout technique}

\begin{figure}
  \includegraphics[clip,angle=0,width=\columnwidth]{Figures/resonance-circle.png}
  \caption{Trajectory of $\I$ and $\Q$ during a frequency sweep around the
    resonance of a KID. The arrows represent $(\di,
    \dq)$. \citep{2013A&A...551L..12C}}
  \label{circle-iq}
\end{figure}

The excitation tone frequency of a KID is modulated by a local oscillator with a
known frequency shift. This provides two values $f_{\pm} = f_0 \pm \delta
  f_{LO}/2$ with $\delta f_{LO} \simeq 1$\,kHz. Time ordered data values $(\mathcal{I}(t),\mathcal{Q}(t))$ are given by :

\begin{equation}
(\mathcal{I}(t), \mathcal{Q}(t)) = (\frac{\mathcal{I}(f_{+}) +
    \mathcal{I}(f_{-})}{2},
\frac{\mathcal{Q}(f_{+}) + \mathcal{Q}(f_{-})}{2}),
\end{equation}

and the differential values are :

\begin{equation}
\label{gradient}
(\frac{\di}{df}(t), \frac{\dq}{df}(t)) =
\left(\frac{\I(f_{+}) - \I(f_{-})}{\delta f_{LO}},
\frac{\Q(f_{+}) - \Q(f_{-})}{\delta f_{LO}}\right).
\end{equation}

These quantities are represented on Fig. \ref{circle-iq}. In this paper, we take
typical laboratory values and assume that $i$ and $q$ are sampled at
880\,Hz. This high acquisition rate is allowed by the sub-millisecond time
constant of the KIDs. For most experiments, such a high sampling rate is not
required and we average these measures over 40~samples to produce
four secondary quantities at 22\,Hz:

\begin{eqnarray}
\I  &=& \sum^{N_{m}=40}_{p=1} i_{p},\\
\Q  &=& \sum^{N_{m}=40}_{p=1} q_{p},\\
d\I &=& \sum^{N_{m}/2=20}_{p=1} i_{2p} - i_{2p-1},\\
d\Q &=& \sum^{N_{m}/2=20}_{p=1} q_{2p} - q_{2p-1}.
\end{eqnarray}

With these quantities in hand we have two methods to derive the transmitted
signal. They are presented in the following paragraphs.

\subsubsection{\methodu}
If a variation $\Delta\I(t)$, $\Delta\Q(t)$ is observed between successive ($\I$,
$\Q$) points, it is possible to estimate the shift of the resonant frequency
$\Delta f_{0}$ between these two samples by comparing ($\Delta \I$, $\Delta \Q$)
with the gradient $(\di,\dq)$ induced by the known and small $\delta
f_{0}$ of the local oscillator. This is done by a scalar projection of ($\Delta\I$,
$\Delta\Q$) on $(\di,\dq)$ that is tangent to the resonance circle. To have a
cleaner estimation of the latter, we take its running average over 50
points that we write $\langle . \rangle_{50}$ \citep{2014A&A...569A...9C}:

\begin{equation}
\label{eq:Rf}
\Delta f_{0} = \delta f_{LO} \frac{\Delta \I\, \langle \di
  \rangle_{50}
+ \Delta \Q\, \langle \dq \rangle_{50}}{\langle \di
  \rangle_{50}^{2}
 + \langle \dq \rangle_{50}^{2}},
\end{equation}

Note that this average is performed only on the tangent vector $(\di,\dq)$ so
that $\Delta f_0$ is sampled like $\I$ and $\Q$ at 22\,Hz. This method has been
successfully used in \nika\ and \nika2. Under large incoming power, the resonances can be shifted far from their excitation frequency. The $(\I, \Q)$ circle is then distorted and the tangent approximation of $(\di, \dq)$ no longer holds which can be the source of non-linearity. In the next paragraph we present an improved method to follow the shift of the resonant frequency.

\subsubsection{\methodd}

\begin{figure}
\includegraphics[clip, angle=0, width=\columnwidth]{Figures/circle_zres.eps}
\caption{Bottom: location of $\I$ and $\Q$ when a KID observes a point source of
  various fluxes. Top: ratio of the distance between $(\I,\Q)$ and the center of
  the fitted circle over the radius of this circle. All the points on the pure
  imaginary line at $\I=1$ are the result of the transformation of the circle
  into $Z_{res}$ according to eqs.~(\ref{eq:z_res}) and
  (\ref{eq:scale_rotate}).}
\label{fig:circle_zres}
\end{figure}

\todo{ref to the circular nature of (I,Q): \cite{2011ApJS..194...24M}}.\\

To improve \methodu, we developed a new technique that fully exploits the circular
nature of the $(\I,\Q)$ trajectory, hereafter called \methodd. It is
  based on the transformation property of a circle in the complex plane into a
  straight line. Indeed, let us consider a circle centered on $(0,1/2)$ with a
  radius of $1/2$ and compute its inverse:

\begin{eqnarray}
Z_{ref} &\equiv&\frac{1}{2} + \frac{1}{2}e^{i\phi}\,, \\
&=&\cos\frac{\phi}{2}e^{i\phi/2}\,,\\
Z_{res} &\equiv& 1/Z_{ref}\,, \label{eq:z_res} \\
&=&1-i\tan\frac{\phi}{2}\,.
\label{eq:z_res}
\end{eqnarray}

$Z_{res}$ is a straight line and along this line $Z$ varies linearly with
$\phi$ for small values of $\phi$. Experimentally, we are in this regime
when the signal is weak and when $\phi$ is defined w.r.t.~ the $(O,C)$ axis
as defined on Fig.~\ref{fig:circle_zres}. We thus fit the radius $r$ and the
center $(\I_c,\Q_c)$ of our measurement circle $Z=\I+j\Q$. Defining
$\alpha=\arctan\Q_c/\I_c$, we scale, rotate and translate this
circle to the $Z_{res}$ circle according to

\begin{equation}
Z_{ref} = \left(\begin{array}{c}
\I_{ref}\\
\Q_{ref}\end{array}\right) = 
\frac{-1}{2r}\left(\begin{array}{rr}
\cos\alpha & \sin\alpha\\
-\sin\alpha & \cos\alpha\end{array}\right)
\left(\begin{array}{c}
\I-\I_c\\
\Q-\Q_c\end{array}\right) +
\left(\begin{array}{c}
1/2\\
0\end{array}\right)
\label{eq:scale_rotate}
\end{equation}

The result of this transformation is shown on Fig.~\ref{fig:circle_zres}. A
variation of the signal $(\Delta\I,\Delta\Q)$ leads to a variation
$\Delta\phi$ along $Z$ that is proportional to the frequency shift $\Delta f$
that we are after to determine photometry. To derive the calibration between
these two quantities, we once again rely on the $(\di,\dq)$ that is induced by
the known $\delta f_{LO}$. Applying transformation (\ref{eq:scale_rotate}) to
$(\di,\dq)$, we obtain the corresponding variation $dy = Im(dZ_{res})$. The
final derivation of $\Delta f$ corresponding to $(\Delta\I,\Delta\Q)$ requires
the integration of $dy/\delta f_{LO}$. For the sake of simplicity, we fit
$Im(dZ_{res})$ as a polynomial of $dy/\delta f_{LO}$ that is therefore trivial
to integrate.\\

%% \begin{equation}
%% \tan\frac{\delta\phi}{2} \simeq \frac{\delta\phi}{2} +
%% \frac{(\delta\phi)^3}{15}
%% \end{equation}


In addition to the non-linearity induced physically by a loss of superconductivity, non-linearity can also arise from the methods that we use to recover the incident optical power. In fact, when the source is very bright (such as planets of several tens of Jy) the change of the density of charge carriers can shift the resonances far from their excitation frequency, and lead to $(\I,\Q)$ measures that leave the resonance circle, hence invalidating the approximations made in the photometric equations of the previous section. Another possible source of non linearity is the instrument scanning speed. Indeed, even if the source is moderately bright, if it is scanned too fast, $(\Delta\I,\Delta\Q)$ could be far from the tangent vector $(\di,\dq)$ which would alter their linear relation.
In this paper we study the impact of non-linearity of a KID on the measure of B modes. In the next section, in a first part we study the impact of non-linearity in total power. In a second part we study the impact of non-linearity induced in polarization measurements by a rotating Half Wave Plate (HWP).

%Induced non-linearities in the two last cases result in a poor reconstruction of the shift of the resonant frequency. In principle this problem should be improved with the \methodd\ method. In this paragraph, we explore the two last cases.\\
